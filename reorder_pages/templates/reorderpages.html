<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reorder PDF Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="{{ url_for('reorder_pages.static', filename='reorderpages.css') }}">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÉÿ™ÿ®ÿ© PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body>
  <div class="dark-mode-toggle">
    <button onclick="toggleDarkMode()">üåô Toggle Dark Mode</button>
  </div>

  <div class="container" id="container">
    <h1 class="page-title"><i class="fa-solid fa-shuffle"></i> Reorder PDF Pages</h1>
    <p class="page-subtitle">Reduce PDF file size while maintaining quality. Fast, private & free!</p>

    <div class="upload-area" id="upload-area">
      <p><i class="fa-solid fa-file-arrow-up fa-2xl"></i></p>
      <p>Click below or drag and drop your PDF file</p>
      <label class="upload-button" for="pdfInput"><i class="fa fa-folder-open"></i> Select PDF File</label>
      <input type="file" id="pdfInput" name="pdf" accept="application/pdf" style="display:none;">
    </div>

    <div id="thumbnailContainer" style="margin-top: 15px;"></div>

    <div class="form-group">
      <label for="orderInput">üî¢ New Page Order:</label>
      <input type="text" id="orderInput" placeholder="e.g. 2,1,3" required />
      <small class="hint">Enter the new page order separated by commas (e.g. 2,1,3)</small>
    </div>


    <button id="compressBtn" class="btn-merge" style="display:none">Reorder Now</button>
    
    <div id="loading-spinner" style="display:none; text-align:center; margin-top:10px;">
      <i class="fa fa-spinner fa-spin fa-2x"></i>
      <p style="font-size: 1rem; margin-top: 10px; color: #e20b0b;">Please wait while we process your PDF securely...</p>
    </div>

    <div class="instructions">
      <h3>üìã How to Use:</h3>
      <ol>
        <li>Select a <strong>PDF file</strong> using the button above or drag it in.</li>
        <li>Enter the desired page order in the text box.</li>
        <li>Click <strong>Reorder Now</strong> to start the process.</li>
        <li>Download your reordered file in seconds!</li>
      </ol>
    </div>
  </div>
  <div class="info-section">
    <div class="info-item">
      <h2>What is PDF Page Reordering?</h2>
      <p>
        PDF page reordering allows you to change the sequence of pages in your PDF document. Whether you need to fix a scanning mistake or rearrange content for clarity, this tool makes it easy.
      </p>
    </div>
    <div class="info-item">
      <h2>Why Use This Tool?</h2>
      <ul>
        <li><strong>Instant Results:</strong> Reorder your PDF pages in seconds.</li>
        <li><strong>Privacy First:</strong> Files never leave your browser.</li>
        <li><strong>Flexible Control:</strong> Choose any page order you need (e.g., 3,1,2).</li>
        <li><strong>100% Free:</strong> No watermarks, no limits, no cost.</li>
      </ul>
    </div>
    <div class="info-item">
      <h2>Safe & Secure</h2>
      <p>
        All reordering happens locally in your browser. Your PDF never gets uploaded, ensuring total privacy and security for your documents.
      </p>
    </div>
  </div>   

  <div class="footer-note">
    This tool works directly in your browser. Your files never leave your device. 100% privacy.
  </div>

  <script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('pdfInput');
    const orderInput = document.getElementById('orderInput');
    const reorderBtn = document.getElementById('compressBtn');  // ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ∑ÿßÿ®ŸÇ ÿßŸÑÿ£ÿ≥ŸÖÿßÿ°
    const thumbnailContainer = document.getElementById('thumbnailContainer');
    let selectedFile = null;

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        handleFile(fileInput.files[0]);
      }
    });

    function handleFile(file) {
      if (file && (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'))) {
        selectedFile = file;
        reorderBtn.style.display = 'block';
        renderThumbnail(file);
      } else {
        Swal.fire('Invalid File', 'Please select a valid PDF file.', 'warning');
      }
    }

    function renderThumbnail(file) {
      const reader = new FileReader();

      reader.onload = function () {
        const typedarray = new Uint8Array(this.result);
        pdfjsLib.getDocument(typedarray).promise.then(pdf => {
          pdf.getPage(1).then(page => {
            const viewport = page.getViewport({ scale: 0.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            page.render({ canvasContext: context, viewport: viewport }).promise.then(() => {
              thumbnailContainer.innerHTML = '';
              thumbnailContainer.appendChild(canvas);
            });
          });
        }).catch(err => {
          console.error('Error loading PDF:', err);
          Swal.fire('Error', 'Could not load PDF preview.', 'error');
        });
      };

      reader.readAsArrayBuffer(file);
    }

    reorderBtn.addEventListener('click', async () => {
      const order = orderInput.value.trim();

      if (!selectedFile) {
        Swal.fire('‚ö†Ô∏è Missing file', 'Please select a PDF file.', 'warning');
        return;
      }

      if (!/^(\d+,)*\d+$/.test(order)) {
        Swal.fire('‚ö†Ô∏è Invalid order', 'Enter order like: 2,1,3', 'warning');
        return;
      }

      reorderBtn.disabled = true;
      reorderBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Reordering...`;

      const formData = new FormData();
      formData.append('pdf', selectedFile);
      formData.append('order', order);

      try {
        const res = await fetch('/reorderpages/start-reorder', {
          method: 'POST',
          body: formData,
        });
        const data = await res.json();

        if (data.success) {
          window.location.href = `/reorderpages/done?session_id=${data.session_id}&filename=${data.filename}`;
         } else {
          Swal.fire('‚ùå Error', data.message || 'Reordering failed.', 'error');
        }
      } catch (err) {
        Swal.fire('‚ùå Error', 'Something went wrong.', 'error');
      } finally {
        reorderBtn.disabled = false;
        reorderBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> Reorder`;
      }
    });

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      document.getElementById('container').classList.toggle('dark-mode');
      uploadArea.classList.toggle('dark-mode');
    }
  </script>
</body>
</html>
